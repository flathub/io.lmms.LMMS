{
  "app-id": "io.lmms.LMMS",
  "base": "com.riverbankcomputing.PyQt.BaseApp",
  "base-version": "5.15-23.08",
  "runtime": "org.kde.Platform",
  "runtime-version": "5.15-23.08",
  "sdk": "org.kde.Sdk",
  "command": "lmms",
  "rename-desktop-file": "lmms.desktop",
  "rename-icon": "lmms",
  "finish-args": [
    "--allow=multiarch",
    "--share=ipc",
    "--socket=x11",
    "--socket=pulseaudio",
    "--device=all",
    "--filesystem=xdg-run/pipewire-0",
    "--filesystem=home",
    "--env=QT_QPA_PLATFORM=xcb",
    "--env=TMPDIR=/var/tmp",
    /* On SuSE it seems to be necessary for sound to work */
    "--env=ALSA_CONFIG_PATH=",
    "--env=LD_LIBRARY_PATH=/app/lib:/app/lib/libgig",
    "--env=DSSI_PATH=/app/extensions/Plugins/dssi",
    "--env=VST_PATH=/app/extensions/Plugins/vst",
    "--env=VST3_PATH=/app/extensions/Plugins/vst3",
    "--env=LADSPA_PATH=/app/extensions/Plugins/ladspa:/app/lib/ladspa",
    "--env=WINELOADER=/app/bin/wine",
    "--env=WINEPREFIX=/run/flatpak/app/io.lmms.LMMS/.wine",
    "--env=WINEDEBUG=warn+all"
  ],
  "add-extensions": {
    "org.freedesktop.LinuxAudio.Plugins": {
      "directory": "extensions/Plugins",
      "version": "23.08",
      "add-ld-path": "lib",
      "merge-dirs": "ladspa;dssi;lv2;vst;vst3",
      "subdirectories": true,
      "no-autodownload": true
    },
    "org.freedesktop.Platform.Compat.i386":{
      "directory":"lib/i386-linux-gnu",
      "version":"23.08"
    },
    "org.freedesktop.Platform.Compat.i386.Debug":{
      "directory":"lib/debug/lib/i386-linux-gnu",
      "version":"23.08",
      "no-autodownload": true
    },
    "org.freedesktop.Platform.GL32":{
      "directory":"lib/i386-linux-gnu/GL",
      "version":"1.4",
      "versions":"23.08;1.4",
      "subdirectories":true,
      "no-autodownload":true,
      "autodelete":false,
      "add-ld-path":"lib",
      "merge-dirs":"vulkan/icd.d;glvnd/egl_vendor.d;OpenCL/vendors;lib/dri;lib/d3d;vulkan/explicit_layer.d;vulkan/implicit_layer.d",
      "download-if":"active-gl-driver",
      "enable-if":"active-gl-driver"
    }
  },
  "sdk-extensions": [
    "org.freedesktop.Sdk.Compat.i386",
    "org.freedesktop.Sdk.Extension.toolchain-i386"
  ],
  "build-options": {
    "env": {
      "BASEAPP_REMOVE_WEBENGINE": "1"
    }
  },
  "cleanup": [
    "/man",
    "/share/man",
    "/share/info",
    "/share/sip",
    "*.la",
    "*.a"
  ],
  "modules": [
    "shared-modules/SDL/SDL-1.2.15.json",
    "shared-modules/linux-audio/fftw3f.json",
    {
      "name": "portaudio",
      "config-opts": [
        "--disable-static",
        "--without-oss"
      ],
      "sources": [
        {
          "type": "archive",
          "url": "https://github.com/PortAudio/portaudio/archive/refs/tags/v19.7.0.tar.gz",
          "sha256": "5af29ba58bbdbb7bbcefaaecc77ec8fc413f0db6f4c4e286c40c3e1b83174fa0"
        }
      ]
    },
    "shared-modules/linux-audio/fluidsynth2.json",
    {
      "name": "carla",
      "buildsystem": "simple",
      "build-commands": [
        "make features",
        "make PREFIX=/app -j $FLATPAK_BUILDER_N_JOBS",
        "make PREFIX=/app install"
      ],
      "cleanup": [
        "/lib/lv2",
        "/lib/vst"
      ],
      "build-options": {
        "arch": {
          "aarch64": {
            "env": {
              "NOOPT": "true"
            }
          }
        }
      },
      "sources": [
        {
          "type": "archive",
          "url": "https://github.com/falkTX/Carla/archive/v2.4.2.tar.gz",
          "sha256": "376884965e685242953cab757818dde262209c651bd563a04eade0678c6b9f39"
        },
        {
          "type": "patch",
          "path": "patches/carla-juce.patch"
        }
      ]
    },
    "shared-modules/linux-audio/stk.json",
    {
      "name": "gig",
      "cleanup": [
        "*.a"
      ],
      "sources": [
        {
          "type": "archive",
          "url": "http://download.linuxsampler.org/packages/libgig-4.1.0.tar.bz2",
          "sha256": "06a280278a323963042acdf13b092644cceb43ef367fcbb9ca7bbedff132bd0b"
        }
      ]
    },
    {
      "name": "fltk",
      "config-opts": [
        "--enable-threads",
        "--enable-cairo",
        "--enable-shared"
      ],
      "sources": [
        {
          "type": "archive",
          "url": "https://github.com/fltk/fltk/archive/release-1.3.5.tar.gz",
          "sha256": "5c534287b0e03b9520ff866704a5649268986b371bdf8f6ac003fa240e761901"
        }
      ],
      "cleanup": [
        "/man",
        "/share/doc",
        "/share/man",
        "*.la",
        "*.a"
      ]
    },
    {
      "name":"vkd3d-32bit",
      "build-options": {
        "prepend-pkg-config-path":"/app/lib32/pkgconfig:/usr/lib/i386-linux-gnu/pkgconfig",
        "ldflags":"-L/app/lib32",
        "prepend-path":"/usr/lib/sdk/toolchain-i386/bin",
        "env":{
          "CC":"i686-unknown-linux-gnu-gcc",
          "CXX":"i686-unknown-linux-gnu-g++"
        },
        "libdir":"/app/lib32"
      },
      "sources": [
        {
          "type": "archive",
          "url": "https://dl.winehq.org/vkd3d/source/vkd3d-1.9.tar.xz",
          "sha256": "9d1ebc6f36cccf40cffda3176851f73a0501b90c4d04e782abe79ca703057a4b"
        }
      ],
      "modules":[
        {
          "name":"spirv-headers",
          "buildsystem":"cmake-ninja",
          "sources":[
            {
              "type":"git",
              "url": "https://github.com/KhronosGroup/SPIRV-Headers.git",
              "tag": "sdk-1.3.261.1",
              "commit": "124a9665e464ef98b8b718d572d5f329311061eb"
            }
          ]
        }
      ]
    },
    {
      "name": "krb5-32bit",
      "build-options": {
        "prepend-pkg-config-path":"/app/lib32/pkgconfig:/usr/lib/i386-linux-gnu/pkgconfig",
        "ldflags":"-L/app/lib32",
        "prepend-path":"/usr/lib/sdk/toolchain-i386/bin",
        "env":{
          "CC":"i686-unknown-linux-gnu-gcc",
          "CXX":"i686-unknown-linux-gnu-g++"
        },
        "libdir":"/app/lib32"
      },
      "subdir": "src",
      "sources": [
        {
          "type": "archive",
          "url": "https://github.com/krb5/krb5/archive/refs/tags/krb5-1.21.2-final.tar.gz",
          "sha256": "5827fa39ead0e7f7b8a158799eb5d50b194129e81b378892caedcafe50c5c195",
          "x-checker-data": {
            "type": "anitya",
            "project-id": 13287,
            "stable-only": true,
            "url-template": "https://github.com/krb5/krb5/archive/refs/tags/krb5-$version.tar.gz"
          }
        },
        {
          "type": "shell",
          "dest": "src",
          "commands": [
            "autoreconf -si"
          ]
        }
      ]
    },
    {
      "name":"wine32",
      "build-options": {
        "prepend-pkg-config-path":"/app/lib32/pkgconfig:/usr/lib/i386-linux-gnu/pkgconfig",
        "ldflags":"-L/app/lib32",
        "prepend-path":"/usr/lib/sdk/toolchain-i386/bin",
        "env":{
          "CC":"i686-unknown-linux-gnu-gcc",
          "CXX":"i686-unknown-linux-gnu-g++"
        },
        "libdir":"/app/lib32"
      },
      "sources": [
        {
          "type": "archive",
          "url": "https://dl.winehq.org/wine/source/7.0/wine-7.0.2.tar.xz",
          "sha256": "e874b4a9c036f2f66b2f2c79012c7f1236afffe840aa0e7c002e7725e75961b9"
        }
      ]
	  },
    {
      "name":"32bitconfig",
      "buildsystem": "simple",
      "build-commands":[
        "mkdir -p /app/lib/i386-linux-gnu",
        "mkdir -p /app/lib/debug/lib/i386-linux-gnu",
        "mkdir -p /app/lib/i386-linux-gnu/GL",
        "install -Dm644 ld.so.conf /app/etc/ld.so.conf"
      ],
      "sources":[
        {
          "type": "file",
          "path": "ld.so.conf"
        }
      ]

    },
    {
      "name":"symlinks",
      "buildsystem": "simple",
      "build-commands": [
        "ln -s /usr/lib/sdk/toolchain-i386/bin/i686-unknown-linux-gnu-gcc /app/bin/i686-unknown-linux-gnu-gcc",
        "ln -s /usr/lib/sdk/toolchain-i386/bin/i686-unknown-linux-gnu-g++ /app/bin/i686-unknown-linux-gnu-g++",
        "ln -s /usr/bin/nm /app/bin/nm",
        "ln -s ./ /app/lib32/wine/i386-unix/wine",
        "echo $PATH",
        "which gcc"
      ],
      "env":{
        "PATH":"/bin:/app/bin:/usr/bin:/usr/lib/sdk/toolchain-i386/bin"
      }
    },
    {
      "name": "lmms",
      "buildsystem": "cmake",
      "config-opts": [
        "-DWANT_QT5=ON",
        "-DWANT_VST=ON",
        "-DCMAKE_PREFIX_PATH=/app",
        "-DCMAKE_VERBOSE_MAKEFILE=ON",
        "-DCMAKE_BUILD_TYPE=Debug",
        "-DWINE_LIBRARY=/app/lib32/wine/i386-unix/libwine.so.1",
        "--trace-source=FindWine.cmake",
        "--trace-expand"
      ],
      "cleanup": [
        "/share/bash-completion"
      ],
      "post-install": [
        "install -Dm644 -t /app/share/metainfo io.lmms.LMMS.metainfo.xml",
        "mv ${FLATPAK_DEST}/share/mime/packages/lmms.xml ${FLATPAK_DEST}/share/mime/packages/${FLATPAK_ID}.xml",
        "cd ${FLATPAK_DEST}/share/icons/hicolor; for d in */mimetypes/; do for f in ${d}*; do mv \"$f\" \"${d}${FLATPAK_ID}.$(basename $f)\"; done; done",
        "mv ${FLATPAK_DEST}/bin/lmms ${FLATPAK_DEST}/bin/lmms.bin",
        "install -Dm755 lmms-wrap.sh ${FLATPAK_DEST}/bin/lmms",
        "install -d /app/extensions/Plugins"
      ],
      "sources": [
        {
          "type": "archive",
          "url": "https://github.com/LMMS/lmms/releases/download/v1.2.2/lmms_1.2.2.tar.xz",
          "sha256": "b185507fb64ecfd8e31145135b58ab244b637f9efc09c4176caf70aa3cbaae1e",
          "x-checker-data": {
              "type": "anitya",
              "project-id": 1832,
              "is-main-source": true,
              "url-template": "https://github.com/LMMS/lmms/releases/download/v$version/lmms_$version.tar.xz"
          }
        },
        {
          "type": "patch",
          "paths": [
            "lmms-stk-path.patch",
            "lmms-mime-icon.patch",
            "lmms-kwidgetsaddons.patch",
            "lmms-findwine.patch",
            "lmms-stdlib.patch"
          ]
        },
        {
          "type": "file",
          "path": "lmms-wrap.sh"
        },
        {
          "type": "file",
          "path": "io.lmms.LMMS.metainfo.xml"
        }
      ]
    },
    {
      "name":"debugfiles",
      "buildsystem":"simple",
      "build-commands": [
        "mv /app/lib/lmms/RemoteVstPlugin /app/lib/lmms/RemoteVstPlugin_",
        "install -Dm755 -t /app/lib/lmms RemoteVstPlugin"
      ],
      "sources":[
        {
          "type": "file",
          "path": "RemoteVstPlugin"
        }
      ]
    }
  ]
}
